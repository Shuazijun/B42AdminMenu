# BuildingCraftUI 窗体自由变换大小实现文档

## 概述

本文档详细分析了 BuildingCraftUI.lua 中窗体自由变换大小的实现机制，旨在帮助开发人员修复失效或过时的窗体缩放 MOD。

## 核心实现机制

### 1. 窗体可调整大小设置

在 `BuildingCraftUI:new()` 构造函数中，通过调用 `o:setResizable(true)` 启用窗体大小调整功能：

```lua
function BuildingCraftUI:new(x, y, width, height, character)
    local o = {};
    o = ISCollapsableWindowJoypad.new(self, x, y, width, height);
    -- ... 其他初始化代码
    o:setResizable(true);  -- 第789行：启用窗体大小调整
    o.title = getText("IGUI_BuildingMenuTitle");
    o.minimumWidth = 670;   -- 设置最小宽度
    o.minimumHeight = 450;  -- 设置最小高度
    return o;
end
```

### 2. 窗体位置和尺寸的保存与恢复

#### 保存机制
在 `BuildingCraftUI:close()` 方法中，窗体的当前位置和尺寸被保存到玩家的 `modData.UIData` 中：

```lua
function BuildingCraftUI:close()
    local modData = self.character:getModData();
    modData.UIData = { 
        x = self:getX(), 
        y = self:getY(), 
        width = self:getWidth(), 
        height = self:getHeight() 
    };
    
    BuildingCraftUI.g_hWnd = nil;
    self:setVisible(false);
    self:removeFromUIManager();
end
```

#### 恢复机制
在 `BuildingCraftUI.openWindow(player)` 函数中，从 `modData.UIData` 读取保存的位置和尺寸：

```lua
function BuildingCraftUI.openWindow(player)
    -- ... 默认位置和尺寸计算
    local UIDataDef = modData.UIData
    
    if UIDataDef then 
        x = UIDataDef.x
        y = UIDataDef.y
        width = UIDataDef.width
        hight = UIDataDef.height
        
        -- 确保最小尺寸
        if not width or width < BuildingCraftUI.UIWndWidth then 
            width = BuildingCraftUI.UIWndWidth
        end 
        if not hight or hight < BuildingCraftUI.UIWndHight then 
            hight = BuildingCraftUI.UIWndHight
        end 
    end 
    -- ... 创建窗口
end
```

### 3. 基础类继承关系

`BuildingCraftUI` 继承自 `ISCollapsableWindowJoypad`，该类提供了可折叠窗口的基本功能：

```lua
BuildingCraftUI = ISCollapsableWindowJoypad:derive("BuildingCraftUI")
```

`ISCollapsableWindowJoypad` 是游戏引擎内置的 UI 类，提供了：
- `setResizable(boolean)` 方法：启用/禁用大小调整
- 内置的调整大小手柄（resize widget）
- 最小/最大尺寸限制支持

### 4. 调整大小手柄高度获取

在 `createChildren()` 方法中，通过 `self:resizeWidgetHeight()` 获取调整大小手柄的高度，用于计算内部组件的布局：

```lua
local resizehight = self:resizeWidgetHeight() or 0
```

### 5. 渲染时的调整大小处理

在 `render()` 方法中，检查窗体是否可调整大小，并相应处理：

```lua
function BuildingCraftUI:render()
    ISCollapsableWindowJoypad.render(self)
    -- ... 其他渲染逻辑
    
    local rh = self.resizable and self:resizeWidgetHeight() or 0;
    local bottomY = self:getHeight() - rh - BuildingMenuSmallHeight;
    
    self:drawBottomText(bottomY)
end
```

## 关键配置参数

### 默认尺寸
```lua
BuildingCraftUI.UIWndWidth = 670   -- 默认宽度
BuildingCraftUI.UIWndHight = 450   -- 默认高度
```

### 最小尺寸限制
```lua
o.minimumWidth = 670    -- 最小宽度
o.minimumHeight = 450   -- 最小高度
```

## 常见问题与修复建议

### 1. 窗体缩放失效的可能原因

#### a) `setResizable(true)` 未正确调用
- 检查 `BuildingCraftUI:new()` 方法中是否包含 `o:setResizable(true)`
- 确保该方法在窗口初始化后立即调用

#### b) 继承链问题
- 确认 `BuildingCraftUI` 正确继承自 `ISCollapsableWindowJoypad`
- 检查基类的 `setResizable` 方法是否可用

#### c) 保存/恢复机制故障
- 验证 `modData.UIData` 的保存和读取逻辑
- 确保玩家 `modData` 在游戏会话间持久化

### 2. 修复过时 MOD 的建议

#### a) 更新基类引用
如果 MOD 使用的是旧版本的 UI 类，需要更新为当前可用的类：
```lua
-- 旧版本可能使用 ISCollapsableWindow
-- 新版本应使用 ISCollapsableWindowJoypad
require("ISUI/ISCollapsableWindowJoypad")
```

#### b) 添加缺失的最小尺寸限制
确保设置了合理的最小尺寸，防止窗体被调整得过小：
```lua
o.minimumWidth = 670
o.minimumHeight = 450
```

#### c) 修复保存/恢复逻辑
确保窗体关闭时保存状态，打开时恢复状态：
```lua
-- 保存
modData.UIData = { x = x, y = y, width = width, height = height }

-- 恢复时检查有效性
if UIDataDef and UIDataDef.width and UIDataDef.height then
    -- 使用保存的尺寸
else
    -- 使用默认尺寸
end
```

### 3. 调试建议

#### a) 检查控制台输出
添加调试输出以验证关键步骤：
```lua
print("setResizable called:", self.resizable)
print("Saved UIData:", modData.UIData)
```

#### b) 验证继承关系
确认类继承正确：
```lua
print("Class hierarchy:", getmetatable(BuildingCraftUI))
```

#### c) 测试保存/恢复
手动检查玩家 `modData` 的内容：
```lua
print("Player modData UIData:", player:getModData().UIData)
```

## 完整实现示例

以下是修复窗体缩放功能的关键代码片段：

```lua
-- 1. 正确继承
require("ISUI/ISCollapsableWindowJoypad")
BuildingCraftUI = ISCollapsableWindowJoypad:derive("BuildingCraftUI")

-- 2. 在构造函数中启用大小调整
function BuildingCraftUI:new(x, y, width, height, character)
    local o = ISCollapsableWindowJoypad.new(self, x, y, width, height)
    o:setResizable(true)  -- 关键：启用大小调整
    o.minimumWidth = 670
    o.minimumHeight = 450
    -- ... 其他初始化
    return o
end

-- 3. 保存窗体状态
function BuildingCraftUI:close()
    local modData = self.character:getModData()
    modData.UIData = {
        x = self:getX(),
        y = self:getY(),
        width = self:getWidth(),
        height = self:getHeight()
    }
    -- ... 关闭逻辑
end

-- 4. 恢复窗体状态
function BuildingCraftUI.openWindow(player)
    local modData = player:getModData()
    local width = BuildingCraftUI.UIWndWidth
    local height = BuildingCraftUI.UIWndHight
    local x, y = -- 默认位置计算
    
    if modData.UIData then
        x = modData.UIData.x or x
        y = modData.UIData.y or y
        width = modData.UIData.width or width
        height = modData.UIData.height or height
        
        -- 确保最小尺寸
        width = math.max(width, BuildingCraftUI.UIWndWidth)
        height = math.max(height, BuildingCraftUI.UIWndHight)
    end
    
    -- 创建窗口
    local window = BuildingCraftUI:new(x, y, width, height, player)
    -- ... 其他初始化
end
```

## 总结

BuildingCraftUI 的窗体自由变换大小功能依赖于以下几个关键组件：

1. **`setResizable(true)`**：启用基础的大小调整功能
2. **`ISCollapsableWindowJoypad` 基类**：提供调整大小手柄和基本行为
3. **`modData.UIData` 保存/恢复**：持久化窗体位置和尺寸
4. **最小尺寸限制**：防止窗体被调整得过小

修复失效的窗体缩放 MOD 时，应重点检查这些组件的正确实现，并确保它们与当前游戏版本兼容。